#!/bin/bash

set -e

FIRST_RUN_MODE=~/.local/state/omarchy/first-run.mode

if [[ -f "$FIRST_RUN_MODE" ]]; then
  rm -f "$FIRST_RUN_MODE"

  bash "$OMARCHY_PATH/install/first-run/battery-monitor.sh"
  bash "$OMARCHY_PATH/install/first-run/firewall.sh"
  bash "$OMARCHY_PATH/install/first-run/gnome-theme.sh"

  # Run all custom first-run scripts
  echo "----------------------------------------------" >> /tmp/omarchy-first-run.log
  echo "Contents of /etc/ufw/applications.d/ufw-sunshine:" >> /tmp/omarchy-first-run.log
  cat /etc/ufw/applications.d/ufw-sunshine >> /tmp/omarchy-first-run.log 2>&1
  sudo ufw app list >> /tmp/omarchy-first-run.log 2>&1
  echo "----------------------------------------------" >> /tmp/omarchy-first-run.log
  echo "Running custom first-run scripts..." >> /tmp/omarchy-first-run.log
  echo "----------------------------------------------" >> /tmp/omarchy-first-run.log
  bash "$OMARCHY_PATH/install/custom/first-run.sh"
  echo "----------------------------------------------" >> /tmp/omarchy-first-run.log
  echo "Finished custom first-run scripts..." >> /tmp/omarchy-first-run.log
  sudo ufw status verbose >> /tmp/omarchy-first-run.log 2>&1
  echo "----------------------------------------------" >> /tmp/omarchy-first-run.log

  sudo rm -f /etc/sudoers.d/first-run

  bash "$OMARCHY_PATH/install/first-run/wifi.sh"
  bash "$OMARCHY_PATH/install/first-run/welcome.sh"
fi
